---
title: "proyecto_contingencias"
author: "Alejandro Brenes - C21319, Santiago Fernández - C22943, Félix Madrigal -
  C24459 y Eyeri Méndez - C24765"
date: "`r Sys.Date()`"
output: html_document
---

# Proyecto contingencias I

## Descarga de datos

Se inicia con la descarga de los datos, para la base de datos de los empleados se agregaron columnas con la edad y el año de nacimiento, para los valores tqx se realizó una tabla dinámica separada por cada sexo, todos los cambios fueron hechos desde MS Excel.

```{r descarga_datos}
library(readxl)
empleados <- read_excel("datos/Base de datos.xlsx")
qx.hombres <- read_excel("datos/tavid2000-2150.xlsx", 
    sheet = "Sexo_1_limpio")
qx.mujeres <- read_excel("datos/tavid2000-2150.xlsx", 
    sheet = "Sexo_2_limpio")
```

Se cambia el nombre y el orden las columnas de la base de empleados.

```{r corr_columnas}
library(dplyr)

# Nombre de columnas
empleados <- empleados %>% 
  rename(
    id = "Número de empleado",
    fecha_nac = "Fecha de nacimiento",
    sexo = Sexo,
    edad = Edad,
    anno_nac = Anno_nac
  )

# Se reordena el DataFrame
empleados <- empleados %>% 
  select(id, sexo, edad, anno_nac, fecha_nac)
```

La edad de las personas se calculó para 2023, se requiere la de 2024, por los que se suma una unidad a esa columna.

```{r corr_edad}
empleados$edad <- empleados$edad + 1
```

## Modelo determinístico

### Proyección demográfica de población de empleados activos

Se creará una función para determinar los empleados activos que continúan vivos cada año por sexo.

```{r fun_activos_vivos}
# La siguiente funcion recibe el DataFrame de los empleados (df.empleados), el DataFrame de probabilidades de muertes por sexo (df.muertes) y el sexo a calcular su proyección (sexo). Es importante que el sexo coincida con el sexo de las probabilidades de muerte, de lo contrario, podría conducir a errores en el cálculo. Se devuelve una lista con: un DataFrame con la población activa que sigue viva por cada año y la matriz de sobrevivientes por edad
pob.activos <- function(df.empleados, df.muertes, sexo) {
  # Se filtra el DataFrame por el sexo
  if (sexo == "M") {
    df.empleados <- df.empleados %>%
      filter(sexo == "M")
  }
  else if (sexo == "F") {
    df.empleados <- df.empleados %>%
      filter(sexo == "F")
  }
  else{
    return("El sexo del parámetro no fue encontrado")
  }
  
  # Las edades de las personas que nos interesan para el estudio
  edades <- c(min(df.empleados$edad):65)
  
  # Contamos la cantidad de personas que hay por cada edad
  num.personas <- as.vector(table(as.factor(df.empleados$edad)))
  
  # Lista para guardar las probabilidades de sobrevivencia
  lista.tpx <- list()
  
  # Se itera para obtener las probabilidades de sobrevivencia de cada edad
  for (edad in edades) {
    # Se obtiene un vector de qx de forma diagonal
    tqx <-
      sapply(0:(65 - edad), function(j)
        as.numeric(df.muertes[edad + 1 + j,  26 + j]))
    
    # Calcula los tpx a partir de los tqx de forma acumulativa
    tpx <-
      c(1, sapply(1:(length(tqx)), function(k)
        prod(1 - tqx[1:k])))
    
    # La longitud de los tpx va disminuyendo, por lo que calculamos los 0 necesarios para formar una matriz posteriormente
    if ((48 - length(tpx)) > 0) {
      tpx <- c(tpx, rep(0, (48 - length(tpx))))
    }
    
    lista.tpx[[(edad - 20)]] <- tpx
  }
  
  # Con todos los vectores en una lista, creamos la matriz, en donde cada fila es la probabilidad de sobrevivencia de una persona de edad x
  matriz.prob <- do.call(rbind, lista.tpx)
  
  # Se realiza la multiplicación de personas por su probabilidad de sobrevivencia
  matriz.final <- num.personas * matriz.prob
  
  # Se crea un dataframe con la cantidad de personas restantes por año, para esto se sumarán las columnas de la matriz anterior
  df.resultado <-
    data.frame(anno = c(2023:(2091 - min(edades))),
               # 2024 + 65 + 1 - min(edades)
               trabajadores = colSums(matriz.final))
  
  # Se devolverá una lista, primero tendrá el resultado en DataFrame y posteriormente tendrá la matriz que indica cuántas personas se pensionarion cada año
  lista.res <- list(df.resultado, matriz.final)
  
  return(lista.res)
}
```

Se guardan las proyecciones demográficas para hombres y mujeres.

```{r act_vivos}
# Hombres activos vivos
activos.vivosh <- pob.activos(empleados, qx.hombres, "M")

# Mujeres activas vivas
activos.vivosm <- pob.activos(empleados, qx.mujeres, "F")
```

### Proyección demográfica de defunciones de empleados activos

Se procede a crear la función de muertes de empleados activos cada año.

```{r fun_activos_muertos}
# La siguiente funcion recibe el DataFrame de los empleados (df.empleados), el DataFrame de probabilidades de muertes por sexo (df.muertes) y el sexo a calcular su proyección (sexo). Es importante que el sexo coincida con el sexo de las probabilidades de muerte, de lo contrario, podría conducir a errores en el cálculo. Se devuelve una lista con: un DataFrame con los fallecidos por cada año y la matriz de fallecidos por edad
def.activos <- function(df.empleados, df.muertes, sexo) {
  # Se filtra el DataFrame por el sexo
  if (sexo == "M") {
    df.empleados <- df.empleados %>%
      filter(sexo == "M")
  }
  else if (sexo == "F") {
    df.empleados <- df.empleados %>%
      filter(sexo == "F")
  }
  else{
    return("El sexo del parámetro no fue encontrado")
  }
  
  # Las edades de las personas que nos interesan para el estudio
  edades <- c(min(df.empleados$edad):65)
  
  # Contamos la cantidad de personas que hay por cada edad
  num.personas <- as.vector(table(as.factor(df.empleados$edad)))
  
  # Lista para guardar las probabilidades de sobrevivencia
  lista.tqx <- list()
  
  # Se itera para obtener las probabilidades de sobrevivencia de cada edad
  for (edad in edades) {
    # Se obtiene un vector de qx de forma diagonal
    qx <-
      sapply(0:(65 - edad), function(j)
        as.numeric(df.muertes[edad + 1 + j,  26 + j]))
    
    # Calcula los tpx a partir de los tqx de forma acumulativa
    tpx <-
      sapply(1:(length(qx)), function(k)
        prod(1 - qx[1:k]))
    
    # Calcula los t|qx a partir de los qx y los tpx de forma acumulativa
    
    if (length(qx) == 1) {
      c(0, qx[1])
    }
    else{
      tqx <-
        c(0, qx[1], sapply(2:(length(qx)), function(l)
          (tpx[(l - 1)] * qx[l])))
    }
    
    # La longitud de los tqx va disminuyendo, por lo que calculamos los 0 necesarios para formar una matriz posteriormente
    if ((48 - length(tqx)) > 0) {
      tqx <- c(tqx, rep(0, (48 - length(tqx))))
    }
    
    lista.tqx[[(edad - 20)]] <- tqx
  }
  
  # Con todos los vectores en una lista, creamos la matriz, en donde cada fila es la probabilidad de sobrevivencia de una persona de edad x
  matriz.prob <-
    matrix(unlist(lista.tqx),
           nrow = length(lista.tqx),
           byrow = TRUE)
  
  # Se realiza la multiplicación de personas por su probabilidad de muerte
  matriz.final <- as.vector(num.personas) * as.matrix(matriz.prob)
  
  # Se crea un dataframe con la cantidad de personas restantes por año, para esto se sumarán las columnas de la matriz anterior
  df.resultado <-
    data.frame(anno = c(2023:(2091 - min(edades))),
               # 2024 + 65 + 2 - min(edades)
               trabajadores = colSums(matriz.final))
  
  # Se devolverá una lista, primero tendrá el resultado en DataFrame y posteriormente tendrá la matriz que indica cuántas personas se pensionarion cada año
  lista.res <- list(df.resultado, matriz.final)
  
  return(lista.res)
}
```

Se guardan los empleados activos fallecidos durante cada año (se comprueba que son los valores correctos al sumar los valores de la segunda columna del DataFrame de las funciones de empleados activos).

```{r act_muertos}
# Hombres activos fallecidos
activos.fallecidosh <- def.activos(empleados, qx.hombres, "M")

# Mujeres activas fallecidas
activos.fallecidosm <- def.activos(empleados, qx.mujeres, "F")
```

### Proyección demográfica de pensionados

Primeramente se determinarán los pensionados que entran cada año para cada sexo, usando lo hecho en el punto a).

```{r pensionados_por_anno}
library(data.table)

# Se extraen las matrices de sobrevivientes por edad para cada sexo
matriz.hombres <- activos.vivosh[[2]]
matriz.mujeres <- activos.vivosm[[2]]

# Función para obtener las entradas de una matriz que tengan a su derecha una entrada igual a 0 (en nuestro contexto, las personas pensionadas)
personas.pensionadas <- function(matriz) {
  
  copia = copy(matriz)
  
  # Se encuentran las posiciones donde el valor a la derecha es igual a 0
  posiciones <- which(copia[, -ncol(copia)] != 0 & copia[, -1] == 0, arr.ind = TRUE)
  
  # Luego se extraen los valores de la matriz en esas posiciones
  valores <- copia[posiciones]
  
  return(valores)
  
}

# Se crean los años donde entran pensionados
anno <- c(2024:2068)

# Se extraen los pensionados hombres usando la función anterior
pensionados <- c(personas.pensionadas(matriz.hombres))

# Se crea el dataframe de pensionados hombres que entran por año
df.pensionadosh <- data.frame(anno = anno, pensionados = pensionados)

# Se extraen las pensionadas mujeres usando la función anterior
pensionados <- c(personas.pensionadas(matriz.mujeres))

# Se crea el dataframe de pensionadas mujeres que entran por año
df.pensionadosm <- data.frame(anno = anno, pensionados = pensionados)

```

Posteriormente se crea la función para determinar los pensionados que continúan vivos cada año por sexo.

```{r fun_pensionados_vivos}

# Función que recibe el DataFrame de los pensionados por sexo (df.pensionados) y el DataFrame de probabilidades de muertes por sexo (df.muertes).

# Devuelve un DataFrame con la cantidad de pensionados vivos que sigue viva cada año.

pob.pensionados <- function(df.pensionados, df.muertes){
  
  # Se obtienen las probabilidades de muerte para las edades de 65 en adelante y del año 2024 en adelante
  matriz.prob <- as.matrix(df.muertes[66:nrow(df.muertes), 26:ncol(df.muertes)])
  
  # Se crea un vector que contendrá la cantidad de pensionados que siguen vivos cada año
  # Se inicializa así porque la cantidad de pensionados vivos para el primer año es simplemente la cantidad de pensionados que entran ese año
  pensionados <- c(df.pensionados$pensionados[1])
  
  # Los años de interés para el proyecto
  anno <- c(2024:2119)
  
  for(i in 2:96){
    
    lista.pensionados <- list()
    
    if((i - 51) > 0){
    
      for(j in (i-50):(i-1)){
        
        if(j <= 45){
          
          probabilidad <- prod(sapply(0:(i-j-1), function(k) (1 - matriz.prob[1+k, j+k])))
        
          lista.pensionados <- append(lista.pensionados, df.pensionados$pensionados[j] * probabilidad)
        
        } # fin if
          
      } # fin for j
      
    } else{
      
      contador <- 1
      
      for(j in 1:(i-1)){
        
        if(contador <= 45){
        
          probabilidad <- prod(sapply(0:(i-j-1), function(k) (1 - matriz.prob[1+k, j+k])))
          
          lista.pensionados <- append(lista.pensionados, df.pensionados$pensionados[contador] * probabilidad)
          
          contador <- contador + 1
        
        } # fin if
        
      } # fin for j
      
      if(i <= 45){
      
        lista.pensionados <- append(lista.pensionados, df.pensionados$pensionados[i])
        
      } # fin if
      
    } # fin if-else
    
    pensionados <- c(pensionados, sum(unlist(lista.pensionados)))
    
  } # fin for i
  
  # Se crea el dataframe con los años y los pensionados vivos y se devuelve
  df.final <- data.frame(anno = anno, pensionados = pensionados)
  
  return(df.final)
  
}

```

Se guardan las proyecciones demográficas de pensionados para hombres y mujeres.

```{r proyeccion_pensionados}

# Hombres pensionados vivos
pensionados.vivosh <- pob.pensionados(df.pensionadosh, qx.hombres)

# Mujeres pensionadas vivas
pensionados.vivosm <- pob.pensionados(df.pensionadosm, qx.mujeres)

```

### Proyección demográfica de defunciones de pensionados

Ahora se va a crear la función de muertes de pensionados para cada año.

```{r fun_pensionados_muertos}

# Funcion que recibe el DataFrame de los pensionados por sexo (df.pensionados) y el DataFrame de probabilidades de muertes por sexo (df.muertes).

# Devuelve un DataFrame con los pensionados fallecidos por cada año.

def.pensionados <- function(df.pensionados, df.muertes){
  
  # Se obtienen las probabilidades de muerte para las edades de 65 en adelante y del año 2024 en adelante
  matriz.prob <- as.matrix(df.muertes[66:nrow(df.muertes), 26:ncol(df.muertes)])
  
  # Se crea un vector vacío que contendrá la cantidad de pensionados fallecidos cada año
  pensionados <- c()
  
  # Los años de interés para el proyecto
  anno <- c(2024:2119)
  
  for(i in 1:96){
    
    lista.pensionados <- list()
    
    if((i - 51) > 0){
    
      for(j in (i-50):(i-1)){
        
        if(j <= 45){
          
          probabilidad.sobrevivir <- prod(sapply(0:(i-j-1), function(k) (1 - matriz.prob[1+k, j+k])))
          
          probabilidad.muerte <- matriz.prob[i-j+1, i]
        
          lista.pensionados <- append(lista.pensionados, df.pensionados$pensionados[j] * probabilidad.sobrevivir * probabilidad.muerte)
        
        } # fin if
          
      } # fin for j
      
    } else{
      
      contador <- 1
      
      for(j in 1:i){
        
        if(contador <= 45){
          
          if(j == i){
        
            probabilidad.sobrevivencia <- 1
          
            probabilidad.muerte <- matriz.prob[1, j]
          
          } else{
            
            probabilidad.sobrevivencia <- prod(sapply(0:(i-j-1), function(k) (1 - matriz.prob[1+k, j+k])))
            
            probabilidad.muerte <- matriz.prob[i-j+1, i]
            
          } # fin if-else
          
          lista.pensionados <- append(lista.pensionados, df.pensionados$pensionados[contador] * probabilidad.sobrevivencia * probabilidad.muerte)
          
          contador <- contador + 1
        
        } # fin if
        
      } # fin for j
      
    } # fin if-else
    
    pensionados <- c(pensionados, sum(unlist(lista.pensionados)))
    
  } # fin for i
  
  df.final <- data.frame(anno = anno, pensionados = pensionados)
  
  return(df.final)
  
}

```

Ahora se guardan los pensionados fallecidos durante cada año.

```{r pensionados_muertos}

# Hombres pensionados fallecidos
pensionados.fallecidosh <- def.pensionados(df.pensionadosh, qx.hombres)

# Mujeres pensionadas fallecidas
pensionados.fallecidosm <- def.pensionados(df.pensionadosm, qx.mujeres)

```



